<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Clone - Final</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
       const socket = io();
        let me = null, isReg = false, base64Ava = "", tempPass = "";
        let allUsers = [], currentRoom = null;

        // –ò–°–ü–û–õ–¨–ó–£–ï–ú sessionStorage –í–ú–ï–°–¢–û localStorage –î–õ–Ø –†–ê–ó–î–ï–õ–ï–ù–ò–Ø –í–ö–õ–ê–î–û–ö
        let activeChatters = new Set(JSON.parse(sessionStorage.getItem('tg_active_chats') || "[]"));

        const emojis = "üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòã üòé üòç üòò ü•∞ üòó üòô ü•≤ üòö ‚ò∫Ô∏è üôÇ ü§ó ü§© ü§î ü´° ü§® üòê üòë üò∂ ü´• üôÑ üòè üò£ üò• üòÆ ü§ê üòØ üò™ üò´ ü•± üò¥ üòå üòõ üòú üòù ü§§ üòí üòì üòî üòï ü´§ üôÉ ü´† ü§ë üò≤ ‚òπÔ∏è üôÅ üòñ üòû üòü üò§ üò¢ üò≠ üò¶ üòß üò® üò© ü§Ø üò¨ üò∞ üò± ü•µ ü•∂ üò≥ ü§™ üòµ üòµ‚Äçüí´ ü•¥ üò† üò° ü§¨ üòá ü•≥ ü•∏ ü•∫ ü•π ü§† ü§° ü§• ü§´ ü§≠ ü´¢ ü´£ üßê ü§ì üòà üëø üëπ üë∫ üíÄ ‚ò†Ô∏è üëª üëΩ üëæ ü§ñ üí©".split(/\s+/);

        function saveToDisk() {
            sessionStorage.setItem('tg_active_chats', JSON.stringify(Array.from(activeChatters)));
        }

        const ep = document.getElementById('emoji-list');
        emojis.forEach(e => {
            const div = document.createElement('div');
            div.className = 'emoji-btn';
            div.innerText = e;
            div.onclick = () => { document.getElementById('mi').value += e + " "; document.getElementById('mi').focus(); };
            ep.appendChild(div);
        });

        window.onload = () => {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —é–∑–µ—Ä–∞ —Ç–æ–∂–µ –∏–∑ —Å–µ—Å—Å–∏–∏
            const saved = sessionStorage.getItem('tg_user');
            if(saved) {
                me = JSON.parse(saved);
                startApp();
                socket.emit('auth_request', { username: me.username, password: me.password, isRegister: false });
            }
        };

        function swapMode() {
            isReg = !isReg;
            document.getElementById('atitle').innerText = isReg ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥';
            document.getElementById('ap2').style.display = isReg ? 'block' : 'none';
        }

        function doAuth() {
            const u = document.getElementById('au').value, p = document.getElementById('ap').value;
            if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
            tempPass = p;
            socket.emit('auth_request', { username: u, password: p, isRegister: isReg });
        }

        socket.on('auth_success', (res) => {
            if(res.needProfile) {
                me = { username: res.username, password: tempPass };
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('prof-ui').style.display = 'flex';
            } else {
                me = res.user;
                sessionStorage.setItem('tg_user', JSON.stringify(me));
                startApp();
            }
        });

        document.getElementById('p_ava').onchange = (e) => {
            const r = new FileReader();
            r.onload = () => base64Ava = r.result;
            r.readAsDataURL(e.target.files[0]);
        };

        function doProf() {
            me.nickname = document.getElementById('p_nick').value;
            me.sysName = document.getElementById('p_sys').value;
            me.avatar = base64Ava;
            socket.emit('save_profile', me);
        }

        socket.on('profile_ready', (u) => { 
            me = u; 
            sessionStorage.setItem('tg_user', JSON.stringify(me)); 
            startApp(); 
        });

        function startApp() {
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('prof-ui').style.display = 'none';
            document.getElementById('main-ui').style.display = 'grid';
            updateSidebar(); 
        }

        function updateSidebar() {
            const query = document.getElementById('user-search').value.toLowerCase().trim();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            if(!me) return;

            allUsers.forEach(u => {
                if(u.username === me.username) return;
                const isSearching = query !== "" && (u.nickname.toLowerCase().includes(query) || u.sysName.toLowerCase().includes(query));
                const isChatActive = activeChatters.has(u.username);

                if(isSearching || isChatActive) {
                    const div = document.createElement('div');
                    div.className = `user-item ${isChatActive ? 'active-chat' : ''}`;
                    div.onclick = () => selectChat(u);
                    div.innerHTML = `<img src="${u.avatar || ''}" class="ava"> <div><b>${u.nickname}</b><br><small>${isChatActive ? 'üí¨ –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç' : '@'+u.sysName}</small></div>`;
                    list.appendChild(div);
                }
            });
        }

        function selectChat(partner) {
            const ids = [me.username, partner.username].sort();
            currentRoom = ids[0] + "_" + ids[1];
            
            activeChatters.add(partner.username);
            saveToDisk();

            document.getElementById('msgs').innerHTML = ''; 
            socket.emit('join_chat', currentRoom);
            updateSidebar();
        }

        document.getElementById('user-search').oninput = updateSidebar;

        socket.on('init_data', (d) => {
            if (!d) return;
            allUsers = d.users || [];
            
            if (d.messages && Array.isArray(d.messages) && me) {
                d.messages.forEach(m => {
                    const parts = m.room.split('_');
                    if (parts.includes(me.username)) {
                        const other = parts.find(id => id !== me.username);
                        if (other) activeChatters.add(other);
                    }
                });
                saveToDisk();
            }
            updateSidebar();
        });

        socket.on('update_users', (u) => { allUsers = u; updateSidebar(); });

        function send() {
            const i = document.getElementById('mi');
            if(!i.value || !currentRoom) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            socket.emit('message', { room: currentRoom, text: i.value, user: me.nickname, sid: me.username, time });
            i.value = '';
        }

        socket.on('message', (m) => {
            if(!me) return;
            const parts = m.room.split('_');
            if(parts.includes(me.username)) {
                const other = parts.find(id => id !== me.username);
                if(other) {
                    activeChatters.add(other);
                    saveToDisk();
                    updateSidebar();
                }
            }
            if(m.room === currentRoom) renderMsg(m);
        });

        socket.on('chat_history', (h) => { h.forEach(renderMsg); });

        function renderMsg(m) {
            const d = document.createElement('div');
            d.className = `msg ${m.sid === me.username ? 'my' : ''}`;
            d.innerHTML = `<b>${m.user}</b><br>${m.text}<span class="msg-time">${m.time || ''}</span>`;
            document.getElementById('msgs').appendChild(d);
            document.getElementById('msgs').scrollTop = 99999;
        }

        function logout() { 
            sessionStorage.clear(); // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â—É—é –≤–∫–ª–∞–¥–∫—É
            location.reload(); 
        }
        socket.on('auth_error', (e) => alert(e));
    </style>
</head>
<body>

    <div id="auth-ui">
        <div class="card">
            <h2 id="atitle">–í—Ö–æ–¥</h2>
            <input type="text" id="au" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="ap" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" id="ap2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display:none">
            <button onclick="doAuth()">–î–∞–ª–µ–µ</button>
            <p onclick="swapMode()" style="color:var(--blue); cursor:pointer; font-size:13px">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>
    </div>

    <div id="prof-ui" style="display:none">
        <div class="card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <input type="text" id="p_nick" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="text" id="p_sys" placeholder="@username">
            <input type="file" id="p_ava" accept="image/*">
            <button onclick="doProf()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>–ú–æ–∏ —á–∞—Ç—ã</span>
                <button onclick="logout()" style="width:auto; margin:0; padding:4px 8px; background:#ff4d4d; font-size:11px">–í—ã–π—Ç–∏</button>
            </div>
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." style="margin:10px; width:calc(100% - 20px)">
            <div id="user-list"></div>
        </div>

        <div class="chat-area">
            <div id="msgs"></div>
            <div style="padding:15px; background:white; display:flex; gap:10px;">
                <input type="text" id="mi" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button onclick="send()" style="width:60px; margin:0">üì§</button>
            </div>
        </div>

        <div class="emoji-panel" id="emoji-list"></div>
    </div>

    <script>
        const socket = io();
        let me = null, isReg = false, base64Ava = "", tempPass = "";
        let allUsers = [], currentRoom = null;

        // –ó–ê–ì–†–£–ñ–ê–ï–ú –ß–ê–¢–´ –ò–ó –ü–ê–ú–Ø–¢–ò –°–†–ê–ó–£ (—á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø–∞–¥–∞–ª–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏)
        let activeChatters = new Set(JSON.parse(localStorage.getItem('tg_active_chats') || "[]"));

        const emojis = "üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòã üòé üòç üòò ü•∞ üòó üòô ü•≤ üòö ‚ò∫Ô∏è üôÇ ü§ó ü§© ü§î ü´° ü§® üòê üòë üò∂ ü´• üôÑ üòè üò£ üò• üòÆ ü§ê üòØ üò™ üò´ ü•± üò¥ üòå üòõ üòú üòù ü§§ üòí üòì üòî üòï ü´§ üôÉ ü´† ü§ë üò≤ ‚òπÔ∏è üôÅ üòñ üòû üòü üò§ üò¢ üò≠ üò¶ üòß üò® üò© ü§Ø üò¨ üò∞ üò± ü•µ ü•∂ üò≥ ü§™ üòµ üòµ‚Äçüí´ ü•¥ üò† üò° ü§¨ üòá ü•≥ ü•∏ ü•∫ ü•π ü§† ü§° ü§• ü§´ ü§≠ ü´¢ ü´£ üßê ü§ì üòà üëø üëπ üë∫ üíÄ ‚ò†Ô∏è üëª üëΩ üëæ ü§ñ üí©".split(/\s+/);

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä
        function saveToDisk() {
            localStorage.setItem('tg_active_chats', JSON.stringify(Array.from(activeChatters)));
        }

        const ep = document.getElementById('emoji-list');
        emojis.forEach(e => {
            const div = document.createElement('div');
            div.className = 'emoji-btn';
            div.innerText = e;
            div.onclick = () => { document.getElementById('mi').value += e + " "; document.getElementById('mi').focus(); };
            ep.appendChild(div);
        });

        window.onload = () => {
            const saved = localStorage.getItem('tg_user');
            if(saved) {
                me = JSON.parse(saved);
                startApp();
                socket.emit('auth_request', { username: me.username, password: me.password, isRegister: false });
            }
        };

        function swapMode() {
            isReg = !isReg;
            document.getElementById('atitle').innerText = isReg ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥';
            document.getElementById('ap2').style.display = isReg ? 'block' : 'none';
        }

        function doAuth() {
            const u = document.getElementById('au').value, p = document.getElementById('ap').value;
            if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
            tempPass = p;
            socket.emit('auth_request', { username: u, password: p, isRegister: isReg });
        }

        socket.on('auth_success', (res) => {
            if(res.needProfile) {
                me = { username: res.username, password: tempPass };
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('prof-ui').style.display = 'flex';
            } else {
                me = res.user;
                localStorage.setItem('tg_user', JSON.stringify(me));
                startApp();
            }
        });

        document.getElementById('p_ava').onchange = (e) => {
            const r = new FileReader();
            r.onload = () => base64Ava = r.result;
            r.readAsDataURL(e.target.files[0]);
        };

        function doProf() {
            me.nickname = document.getElementById('p_nick').value;
            me.sysName = document.getElementById('p_sys').value;
            me.avatar = base64Ava;
            socket.emit('save_profile', me);
        }

        socket.on('profile_ready', (u) => { me = u; localStorage.setItem('tg_user', JSON.stringify(me)); startApp(); });

        function startApp() {
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('prof-ui').style.display = 'none';
            document.getElementById('main-ui').style.display = 'grid';
            updateSidebar(); 
        }

        function updateSidebar() {
            const query = document.getElementById('user-search').value.toLowerCase().trim();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            if(!me) return;

            allUsers.forEach(u => {
                if(u.username === me.username) return;
                const isSearching = query !== "" && (u.nickname.toLowerCase().includes(query) || u.sysName.toLowerCase().includes(query));
                const isChatActive = activeChatters.has(u.username);

                if(isSearching || isChatActive) {
                    const div = document.createElement('div');
                    div.className = `user-item ${isChatActive ? 'active-chat' : ''}`;
                    div.onclick = () => selectChat(u);
                    div.innerHTML = `<img src="${u.avatar || ''}" class="ava"> <div><b>${u.nickname}</b><br><small>${isChatActive ? 'üí¨ –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç' : '@'+u.sysName}</small></div>`;
                    list.appendChild(div);
                }
            });
        }

        function selectChat(partner) {
            const ids = [me.username, partner.username].sort();
            currentRoom = ids[0] + "_" + ids[1];
            
            activeChatters.add(partner.username); // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ
            saveToDisk(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å –±—Ä–∞—É–∑–µ—Ä–∞

            document.getElementById('msgs').innerHTML = ''; 
            socket.emit('join_chat', currentRoom);
            updateSidebar();
        }

        document.getElementById('user-search').oninput = updateSidebar;

        socket.on('init_data', (d) => {
            if (!d) return;
            allUsers = d.users || [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π, —á—Ç–æ–±—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —á–∞—Ç—ã
            if (d.messages && Array.isArray(d.messages) && me) {
                d.messages.forEach(m => {
                    const parts = m.room.split('_');
                    if (parts.includes(me.username)) {
                        const other = parts.find(id => id !== me.username);
                        if (other) activeChatters.add(other);
                    }
                });
                saveToDisk();
            }
            updateSidebar();
        });

        socket.on('update_users', (u) => { allUsers = u; updateSidebar(); });

        function send() {
            const i = document.getElementById('mi');
            if(!i.value || !currentRoom) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            socket.emit('message', { room: currentRoom, text: i.value, user: me.nickname, sid: me.username, time });
            i.value = '';
        }

        socket.on('message', (m) => {
            if(!me) return;
            const parts = m.room.split('_');
            if(parts.includes(me.username)) {
                const other = parts.find(id => id !== me.username);
                if(other) {
                    activeChatters.add(other);
                    saveToDisk(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º, –µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    updateSidebar();
                }
            }
            if(m.room === currentRoom) renderMsg(m);
        });

        socket.on('chat_history', (h) => { h.forEach(renderMsg); });

        function renderMsg(m) {
            const d = document.createElement('div');
            d.className = `msg ${m.sid === me.username ? 'my' : ''}`;
            d.innerHTML = `<b>${m.user}</b><br>${m.text}<span class="msg-time">${m.time || ''}</span>`;
            document.getElementById('msgs').appendChild(d);
            document.getElementById('msgs').scrollTop = 99999;
        }

        function logout() { 
            localStorage.clear(); 
            location.reload(); 
        }
        socket.on('auth_error', (e) => alert(e));
    </script>
</body>

</html>
