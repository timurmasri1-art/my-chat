<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Clone - Pro Edition</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --blue: #2481cc; --bg: #e7ebf0; --yellow: #f1c40f; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f5; height: 100vh; display: flex; overflow: hidden; }
        
        #auth-ui, #prof-ui, #blocked-ui { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #blocked-ui { background: rgba(0,0,0,0.9); color: white; text-align: center; display: none; }
        
        .card { width: 320px; text-align: center; border: 1px solid #ddd; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--blue); color: white; border: none; cursor: pointer; font-weight: bold; }

        #main-ui { display: none; width: 100%; height: 100vh; grid-template-columns: 300px 1fr 250px; }
        
        .sidebar { background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .user-list-container { flex: 1; overflow-y: auto; }
        .user-item { padding: 12px; border-bottom: 1px solid #f9f9f9; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-item:hover { background: #f0f7ff; }
        .user-item.active-chat { border-left: 4px solid var(--blue); background: #f8fbff; }
        .ava { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #eee; }

        .chat-area { display: flex; flex-direction: column; background: var(--bg); border-right: 1px solid #ddd; height: 100vh; overflow: hidden; }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; max-width: 75%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word;}
        .msg.my { align-self: flex-end; background: #effdde; }
        .msg-time { font-size: 10px; color: #888; display: block; text-align: right; margin-top: 5px; }
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; }

        .input-panel { padding: 15px; background: white; display: flex; gap: 8px; border-top: 1px solid #ddd; align-items: center; }
        .attach-btn { width: 45px !important; background: var(--yellow) !important; color: black !important; font-size: 20px; }
        .voice-btn { width: 45px !important; background: #50a33a !important; font-size: 20px; user-select: none; }
        .voice-btn.recording { background: #ff4d4d !important; animation: pulse 1s infinite; }
        #v-timer { color: #ff4d4d; font-weight: bold; font-size: 12px; display: none; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .emoji-panel { background: white; padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 100vh; }
        .emoji-btn { font-size: 26px; cursor: pointer; padding: 8px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

    <div id="blocked-ui">
        <h1>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h1>
        <p>–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —á–∞—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>
        <button onclick="location.reload()" style="width:200px">–Ø —Ä–∞–∑—Ä–µ—à–∏–ª, –æ–±–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div id="auth-ui">
        <div class="card">
            <h2 id="atitle">–í—Ö–æ–¥</h2>
            <input type="text" id="au" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="ap" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" id="ap2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display:none">
            <button onclick="doAuth()">–î–∞–ª–µ–µ</button>
            <p onclick="swapMode()" style="color:var(--blue); cursor:pointer; font-size:13px">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>
    </div>

    <div id="prof-ui" style="display:none">
        <div class="card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <input type="text" id="p_nick" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="text" id="p_sys" placeholder="@username">
            <input type="file" id="p_ava" accept="image/*">
            <button onclick="doProf()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>–ß–∞—Ç—ã</span>
                <button onclick="logout()" style="width:auto; margin:0; padding:4px 8px; background:#ff4d4d; font-size:11px">–í—ã–π—Ç–∏</button>
            </div>
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="updateSidebar()" style="margin:10px; width:calc(100% - 20px)">
            <div id="user-list" class="user-list-container"></div>
        </div>

        <div class="chat-area">
            <div id="msgs"></div>
            <div class="input-panel">
                <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                <input type="file" id="file-input" style="display:none" onchange="sendFile(this)">
                
                <input type="text" id="mi" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter') send()">
                
                <span id="v-timer">20s</span>
                <button id="v-btn" class="voice-btn">üéô</button>
                <button onclick="send()" style="width:50px; margin:0; background:var(--blue)">üì§</button>
            </div>
        </div>
        <div class="emoji-panel" id="emoji-list"></div>
    </div>

    <script>
        const socket = io();
        let me = null, allUsers = [], currentRoom = null, isReg = false;
        let activeChatters = new Set(JSON.parse(sessionStorage.getItem('tg_active_chats') || "[]"));

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        if (Notification.permission !== "granted") {
            Notification.requestPermission().then(res => {
                if(res !== "granted") document.getElementById('blocked-ui').style.display = 'flex';
            });
        }

        // --- –§–£–ù–ö–¶–ò–ò –§–ê–ô–õ–û–í ---
        function sendFile(input) {
            const file = input.files[0];
            if (!file || !currentRoom) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                socket.emit('message', { 
                    room: currentRoom, 
                    file: e.target.result, 
                    fileName: file.name,
                    fileType: file.type,
                    user: me.nickname, 
                    sid: me.username, 
                    time 
                });
            };
            reader.readAsDataURL(file);
            input.value = ""; // –°–±—Ä–æ—Å
        }

        // –í—Å—Ç–∞–≤–∫–∞ –∏–∑ –±—É—Ñ–µ—Ä–∞ (Ctrl + V)
        window.addEventListener('paste', (e) => {
            const item = e.clipboardData.items[0];
            if (item && item.type.indexOf('image') !== -1) {
                const blob = item.getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    socket.emit('message', { room: currentRoom, file: event.target.result, fileType: 'image/png', user: me.nickname, sid: me.username, time });
                };
                reader.readAsDataURL(blob);
            }
        });

        // --- –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–û–í–´–• (20 —Å–µ–∫) ---
        let mediaRecorder, audioChunks = [], stream = null, recordingTimeout, timerInterval;
        const vBtn = document.getElementById('v-btn'), vTimer = document.getElementById('v-timer');

        async function initMedia() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                    if (audioBlob.size < 2000) return;
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        socket.emit('message', { room: currentRoom, voice: reader.result, user: me.nickname, sid: me.username, time });
                    };
                    reader.readAsDataURL(audioBlob);
                    audioChunks = [];
                    vTimer.style.display = "none";
                    clearInterval(timerInterval);
                };
                return true;
            } catch { return false; }
        }

        vBtn.onmousedown = async () => {
            if (!currentRoom || !(stream || await initMedia())) return;
            vBtn.classList.add('recording');
            audioChunks = [];
            mediaRecorder.start();
            let left = 20;
            vTimer.innerText = left + "s";
            vTimer.style.display = "inline";
            timerInterval = setInterval(() => { vTimer.innerText = (--left) + "s"; }, 1000);
            recordingTimeout = setTimeout(() => vBtn.onmouseup(), 20000);
        };

        vBtn.onmouseup = () => {
            if (mediaRecorder?.state === "recording") {
                vBtn.classList.remove('recording');
                clearTimeout(recordingTimeout);
                mediaRecorder.stop();
            }
        };

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        socket.on('message', (m) => {
            if(m.room === currentRoom) {
                renderMsg(m);
            } else if (m.sid !== me.username) {
                // –ò—â–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏
                const sender = allUsers.find(u => u.username === m.sid);
                new Notification(`–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${m.user}`, {
                    body: m.text || (m.voice ? "–ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" : "–§–∞–π–ª/–§–æ—Ç–æ"),
                    icon: sender?.avatar || ""
                });
            }
        });

        // --- –ë–ê–ó–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
        function send() {
            const i = document.getElementById('mi');
            if(!i.value || !currentRoom) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            socket.emit('message', { room: currentRoom, text: i.value, user: me.nickname, sid: me.username, time });
            i.value = '';
        }

        function renderMsg(m) {
            const msgsDiv = document.getElementById('msgs');
            const d = document.createElement('div');
            d.className = `msg ${m.sid === me.username ? 'my' : ''}`;
            let content = `<b>${m.user}</b><br>`;
            
            if (m.voice) content += `<audio controls src="${m.voice}" style="width:200px;height:35px"></audio>`;
            else if (m.file) {
                if (m.fileType.includes('image')) content += `<img src="${m.file}">`;
                else if (m.fileType.includes('video')) content += `<video controls src="${m.file}" style="width:100%"></video>`;
                else content += `<a href="${m.file}" download="${m.fileName || 'file'}">üìé –î–æ–∫—É–º–µ–Ω—Ç: ${m.fileName || '–°–∫–∞—á–∞—Ç—å'}</a>`;
            } 
            else content += m.text;

            content += `<span class="msg-time">${m.time}</span>`;
            d.innerHTML = content;
            msgsDiv.appendChild(d);
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
        }

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ò–ù–¢–ï–†–§–ï–ô–° ---
        function swapMode() { isReg = !isReg; document.getElementById('atitle').innerText = isReg ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥'; document.getElementById('ap2').style.display = isReg ? 'block' : 'none'; }
        function doAuth() { socket.emit('auth_request', { username: au.value, password: ap.value, isRegister: isReg }); }
        socket.on('auth_success', (res) => { if(res.needProfile) { me = {username: res.username}; auth_ui.style.display='none'; prof_ui.style.display='flex'; } else { me = res.user; sessionStorage.setItem('tg_user', JSON.stringify(me)); startApp(); } });
        function doProf() {
            me.nickname = p_nick.value; me.sysName = p_sys.value;
            const f = p_ava.files[0];
            if(f) { const r = new FileReader(); r.onload=()=>{me.avatar=r.result; socket.emit('save_profile', me);}; r.readAsDataURL(f); }
            else socket.emit('save_profile', me);
        }
        socket.on('profile_ready', (u) => { me = u; sessionStorage.setItem('tg_user', JSON.stringify(me)); startApp(); });
        function startApp() { auth_ui.style.display='none'; prof_ui.style.display='none'; main_ui.style.display='grid'; socket.emit('get_users'); }
        socket.on('init_data', (d) => { allUsers = d.users; updateSidebar(); });
        socket.on('update_users', (u) => { allUsers = u; updateSidebar(); });
        
        function updateSidebar() {
            const q = document.getElementById('user-search').value.toLowerCase();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            allUsers.forEach(u => {
                if(u.username === me.username) return;
                if(activeChatters.has(u.username) || u.nickname.toLowerCase().includes(q)) {
                    const div = document.createElement('div');
                    div.className = `user-item ${currentRoom?.includes(u.username) ? 'active-chat' : ''}`;
                    div.onclick = () => selectChat(u);
                    div.innerHTML = `<img src="${u.avatar || ''}" class="ava"> <div><b>${u.nickname}</b><br><small>@${u.sysName}</small></div>`;
                    list.appendChild(div);
                }
            });
        }
        function selectChat(p) {
            const ids = [me.username, p.username].sort();
            currentRoom = ids[0] + "_" + ids[1];
            activeChatters.add(p.username);
            sessionStorage.setItem('tg_active_chats', JSON.stringify([...activeChatters]));
            msgs.innerHTML = '';
            socket.emit('join_chat', currentRoom);
            updateSidebar();
        }

        const emojis = "üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòã üòé üòç üòò ü•∞ üòó üòô ü•≤ üòö ‚ò∫Ô∏è üôÇ ü§ó ü§© ü§î ü´° ü§® üòê üòë üò∂ ü´• üôÑ üòè üò£ üò• üòÆ ü§ê üòØ üò™ üò´ ü•± üò¥ üòå üòõ üòú üòù ü§§ üòí üòì üòî üòï ü´§ üôÉ ü´† ü§ë üò≤ ‚òπÔ∏è üôÅ üòñ üòû üòü üò§ üò¢ üò≠ üò¶ üòß üò® üò© ü§Ø üò¨ üò∞ üò± ü•µ ü•∂ üò≥ ü§™ üòµ üòµ‚Äçüí´ ü•¥ üò† üò° ü§¨ üòá ü•≥ ü•∏ ü•∫ ü•π ü§† ü§° ü§• ü§´ ü§≠ ü´¢ ü´£ üßê ü§ì üòà üëø üëπ üë∫ üíÄ ‚ò†Ô∏è üëª üëΩ üëæ ü§ñ üí©".split(" ");
        emojis.forEach(e => {
            const d = document.createElement('div'); d.className='emoji-btn'; d.innerText=e;
            d.onclick=()=>{mi.value+=e; mi.focus();}; emoji_list.appendChild(d);
        });
        function logout() { sessionStorage.clear(); location.reload(); }
    </script>
</body>
</html>
