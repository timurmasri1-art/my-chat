<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Clone - Voice Messages</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
       /* ... —Å—Ç–∞—Ä—ã–µ —Å—Ç–∏–ª–∏ ... */

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å–∫—Ä–µ–ø–∫–∏ */
    .attach-btn {
        width: 50px !important;
        background: #f4b400 !important; /* –ñ–µ–ª—Ç—ã–π —Ñ–æ–Ω */
        font-size: 20px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã input-panel –¥–ª—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ */
    .input-panel {
        padding: 10px;
        background: white;
        display: flex;
        gap: 8px;
        border-top: 1px solid #ddd;
        align-items: center;
    }

    .input-panel input[type="text"] {
        flex: 1; /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–µ–ø–µ—Ä—å –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Å–µ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ */
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–µ–¥–∏–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
    .msg img, .msg video {
        max-width: 100%;
        border-radius: 8px;
        margin-top: 5px;
    }
        :root { --blue: #2481cc; --bg: #e7ebf0; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f5; height: 100vh; display: flex; overflow: hidden; }
        
        #auth-ui, #prof-ui { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { width: 320px; text-align: center; border: 1px solid #ddd; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--blue); color: white; border: none; cursor: pointer; font-weight: bold; }

        #main-ui { display: none; width: 100%; height: 100vh; grid-template-columns: 300px 1fr 250px; }
        
        .sidebar { background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .user-list-container { flex: 1; overflow-y: auto; }
        .user-item { padding: 12px; border-bottom: 1px solid #f9f9f9; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-item:hover { background: #f0f7ff; }
        .user-item.active-chat { border-left: 4px solid var(--blue); background: #f8fbff; }
        .ava { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #eee; }

        .chat-area { display: flex; flex-direction: column; background: var(--bg); border-right: 1px solid #ddd; height: 100vh; overflow: hidden; }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; max-width: 75%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.my { align-self: flex-end; background: #effdde; }
        .msg-time { font-size: 10px; color: #888; display: block; text-align: right; margin-top: 5px; }

        .input-panel { padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #ddd; align-items: center; }
        .voice-btn { width: 50px !important; background: #50a33a !important; font-size: 20px; user-select: none; transition: 0.2s; }
        .voice-btn.recording { background: #ff4d4d !important; animation: pulse 1s infinite; }
        
        #v-timer { color: #ff4d4d; font-weight: bold; font-size: 14px; display: none; min-width: 30px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .emoji-panel { background: white; padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 100vh; }
        .emoji-btn { font-size: 26px; cursor: pointer; padding: 8px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

    <div id="auth-ui">
        <div class="card">
            <h2 id="atitle">–í—Ö–æ–¥</h2>
            <input type="text" id="au" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="ap" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" id="ap2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display:none">
            <button onclick="doAuth()">–î–∞–ª–µ–µ</button>
            <p onclick="swapMode()" style="color:var(--blue); cursor:pointer; font-size:13px">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>
    </div>

    <div id="prof-ui" style="display:none">
        <div class="card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <input type="text" id="p_nick" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="text" id="p_sys" placeholder="@username">
            <input type="file" id="p_ava" accept="image/*">
            <button onclick="doProf()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>–ú–æ–∏ —á–∞—Ç—ã</span>
                <button onclick="logout()" style="width:auto; margin:0; padding:4px 8px; background:#ff4d4d; font-size:11px">–í—ã–π—Ç–∏</button>
            </div>
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." style="margin:10px; width:calc(100% - 20px)">
            <div id="user-list" class="user-list-container"></div>
        </div>

        <div class="chat-area">
            <div id="msgs"></div>
            <div class="input-panel">
                <input type="text" id="mi" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter') send()">
                <span id="v-timer">20s</span>
                <button id="v-btn" class="voice-btn">üéô</button>
                <button onclick="send()" style="width:60px; margin:0">üì§</button>
            </div>
        </div>

        <div class="emoji-panel" id="emoji-list"></div>
    </div>

    <script>
        const socket = io();
        let me = null, allUsers = [], currentRoom = null;
        let activeChatters = new Set(JSON.parse(sessionStorage.getItem('tg_active_chats') || "[]"));

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –ì–°
        let mediaRecorder;
        let audioChunks = [];
        let stream = null;
        let recordingTimeout; 
        let timerInterval;

        const emojis = "üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòã üòé üòç üòò ü•∞ üòó üòô ü•≤ üòö ‚ò∫Ô∏è üôÇ ü§ó ü§© ü§î ü´° ü§® üòê üòë üò∂ ü´• üôÑ üòè üò£ üò• üòÆ ü§ê üòØ üò™ üò´ ü•± üò¥ üòå üòõ üòú üòù ü§§ üòí üòì üòî üòï ü´§ üôÉ ü´† ü§ë üò≤ ‚òπÔ∏è üôÅ üòñ üòû üòü üò§ üò¢ üò≠ üò¶ üòß üò® üò© ü§Ø üò¨ üò∞ üò± ü•µ ü•∂ üò≥ ü§™ üòµ üòµ‚Äçüí´ ü•¥ üò† üò° ü§¨ üòá ü•≥ ü•∏ ü•∫ ü•π ü§† ü§° ü§• ü§´ ü§≠ ü´¢ ü´£ üßê ü§ì üòà üëø üëπ üë∫ üíÄ ‚ò†Ô∏è üëª üëΩ üëæ ü§ñ üí©".split(/\s+/);

        const vBtn = document.getElementById('v-btn');
        const vTimer = document.getElementById('v-timer');

        // --- –õ–û–ì–ò–ö–ê –ì–û–õ–û–°–û–í–´–• ---
        async function initMedia() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                
                mediaRecorder.onstop = async () => {
                    stopTimerDisplay();
                    const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                    if (audioBlob.size < 1000) return; // –ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ

                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => {
                        const base64Audio = reader.result;
                        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        socket.emit('message', { 
                            room: currentRoom, 
                            voice: base64Audio, 
                            user: me.nickname, 
                            sid: me.username, 
                            time 
                        });
                    };
                    audioChunks = [];
                };
                return true;
            } catch (err) {
                alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
                return false;
            }
        }

        function startTimerDisplay() {
            let timeLeft = 20;
            vTimer.innerText = timeLeft + "s";
            vTimer.style.display = "inline";
            timerInterval = setInterval(() => {
                timeLeft--;
                vTimer.innerText = timeLeft + "s";
                if (timeLeft <= 0) stopTimerDisplay();
            }, 1000);
        }

        function stopTimerDisplay() {
            clearInterval(timerInterval);
            vTimer.style.display = "none";
        }

        vBtn.onmousedown = async (e) => {
            if (!currentRoom) return;
            if (!stream) {
                const allowed = await initMedia();
                if (!allowed) return;
            }
            if (mediaRecorder && mediaRecorder.state === "inactive") {
                vBtn.classList.add('recording');
                audioChunks = [];
                mediaRecorder.start();
                startTimerDisplay();

                // –ê–≤—Ç–æ-—Å—Ç–æ–ø —á–µ—Ä–µ–∑ 20 —Å–µ–∫—É–Ω–¥
                recordingTimeout = setTimeout(() => {
                    if (mediaRecorder.state === "recording") vBtn.onmouseup();
                }, 20000);
            }
        };

        vBtn.onmouseup = () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                vBtn.classList.remove('recording');
                clearTimeout(recordingTimeout);
                mediaRecorder.stop();
            }
        };

        vBtn.onmouseleave = vBtn.onmouseup;

        // --- –û–°–¢–ê–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        function saveToDisk() {
            sessionStorage.setItem('tg_active_chats', JSON.stringify(Array.from(activeChatters)));
        }

        const ep = document.getElementById('emoji-list');
        emojis.forEach(e => {
            const div = document.createElement('div');
            div.className = 'emoji-btn';
            div.innerText = e;
            div.onclick = () => { document.getElementById('mi').value += e + " "; document.getElementById('mi').focus(); };
            ep.appendChild(div);
        });

        window.onload = () => {
            const saved = sessionStorage.getItem('tg_user');
            if(saved) {
                me = JSON.parse(saved);
                startApp();
                socket.emit('auth_request', { username: me.username, password: me.password, isRegister: false });
            }
        };

        function swapMode() {
            isReg = !isReg;
            document.getElementById('atitle').innerText = isReg ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥';
            document.getElementById('ap2').style.display = isReg ? 'block' : 'none';
        }

        function doAuth() {
            const u = document.getElementById('au').value, p = document.getElementById('ap').value;
            if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
            socket.emit('auth_request', { username: u, password: p, isRegister: isReg });
        }

        socket.on('auth_success', (res) => {
            if(res.needProfile) {
                me = { username: res.username };
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('prof-ui').style.display = 'flex';
            } else {
                me = res.user;
                sessionStorage.setItem('tg_user', JSON.stringify(me));
                startApp();
            }
        });

        function doProf() {
            me.nickname = document.getElementById('p_nick').value;
            me.sysName = document.getElementById('p_sys').value;
            const file = document.getElementById('p_ava').files[0];
            if (file) {
                const r = new FileReader();
                r.onload = () => { me.avatar = r.result; socket.emit('save_profile', me); };
                r.readAsDataURL(file);
            } else { socket.emit('save_profile', me); }
        }

        socket.on('profile_ready', (u) => { me = u; sessionStorage.setItem('tg_user', JSON.stringify(me)); startApp(); });

        function startApp() {
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('prof-ui').style.display = 'none';
            document.getElementById('main-ui').style.display = 'grid';
            updateSidebar(); 
        }

        function updateSidebar() {
            const query = document.getElementById('user-search').value.toLowerCase().trim();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            allUsers.forEach(u => {
                if(me && u.username === me.username) return;
                const isSearching = query !== "" && (u.nickname.toLowerCase().includes(query) || u.sysName.toLowerCase().includes(query));
                const isChatActive = activeChatters.has(u.username);
                if(isSearching || isChatActive) {
                    const div = document.createElement('div');
                    div.className = `user-item ${isChatActive ? 'active-chat' : ''}`;
                    div.onclick = () => selectChat(u);
                    div.innerHTML = `<img src="${u.avatar || ''}" class="ava"> <div><b>${u.nickname}</b><br><small>@${u.sysName}</small></div>`;
                    list.appendChild(div);
                }
            });
        }

        function selectChat(partner) {
            const ids = [me.username, partner.username].sort();
            currentRoom = ids[0] + "_" + ids[1];
            activeChatters.add(partner.username);
            saveToDisk();
            document.getElementById('msgs').innerHTML = ''; 
            socket.emit('join_chat', currentRoom);
            updateSidebar();
        }

        function send() {
            const i = document.getElementById('mi');
            if(!i.value || !currentRoom) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            socket.emit('message', { room: currentRoom, text: i.value, user: me.nickname, sid: me.username, time });
            i.value = '';
        }

        socket.on('init_data', (d) => { allUsers = d.users || []; updateSidebar(); });
        socket.on('update_users', (u) => { allUsers = u; updateSidebar(); });

        socket.on('message', (m) => {
            if(m.room === currentRoom) renderMsg(m);
        });

        socket.on('chat_history', (h) => { h.forEach(renderMsg); });

        function renderMsg(m) {
            const msgsDiv = document.getElementById('msgs');
            const d = document.createElement('div');
            d.className = `msg ${m.sid === me.username ? 'my' : ''}`;
            
            let content = `<b>${m.user}</b><br>`;
            if (m.voice) {
                content += `<audio controls src="${m.voice}" style="width: 200px; height: 35px;"></audio>`;
            } else {
                content += m.text;
            }
            content += `<span class="msg-time">${m.time || ''}</span>`;
            
            d.innerHTML = content;
            msgsDiv.appendChild(d);
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
        }

        function logout() { sessionStorage.clear(); location.reload(); }
        socket.on('auth_error', (e) => alert(e));
        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ---
    async function initNotifications() {
        if (!("Notification" in window)) {
            alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è");
            return;
        }

        let permission = await Notification.requestPermission();
        if (permission !== "granted") {
            document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –î–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</h1>";
            throw new Error("Permission denied");
        }
    }

    // --- –û–ë–†–ê–ë–û–¢–ö–ê –§–ê–ô–õ–û–í –ò CTRL+V ---
    const messageInput = document.getElementById('mi');

    messageInput.onpaste = (event) => {
        const items = (event.clipboardData || event.originalEvent.clipboardData).items;
        for (let item of items) {
            if (item.kind === 'file') {
                const blob = item.getAsFile();
                sendFile(blob);
            }
        }
    };

    function handleFileUpload(input) {
        if (input.files && input.files[0]) {
            sendFile(input.files[0]);
            input.value = ''; // —Å–±—Ä–æ—Å –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≥–æ –∂–µ —Ñ–∞–π–ª–∞
        }
    }

    function sendFile(file) {
        if (!currentRoom) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç");
        const reader = new FileReader();
        reader.onload = (e) => {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const fileData = {
                room: currentRoom,
                file: e.target.result,
                fileName: file.name,
                fileType: file.type,
                user: me.nickname,
                sid: me.username,
                time
            };
            socket.emit('message', fileData);
        };
        reader.readAsDataURL(file);
    }

    // --- –ú–û–î–ò–§–ò–¶–ò–†–û–í–ê–ù–ù–´–ô RENDER –ò MESSAGE ---
    socket.on('message', (m) => {
        if (m.room === currentRoom) {
            renderMsg(m);
        } else {
            // –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –≤ –¥—Ä—É–≥–æ–π —á–∞—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showPushNotification(m);
        }
    });

    function showPushNotification(m) {
        // –ù–∞—Ö–æ–¥–∏–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –≤ —Å–ø–∏—Å–∫–µ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏
        const sender = allUsers.find(u => u.username === m.sid);
        const icon = sender ? sender.avatar : '/default-avatar.png';
        
        let bodyText = m.text || "–û—Ç–ø—Ä–∞–≤–∏–ª —Ñ–∞–π–ª/–≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";
        if (m.voice) bodyText = "üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ";
        if (m.file) bodyText = "üìÅ –§–∞–π–ª: " + (m.fileName || "–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è");

        const notification = new Notification(m.user, {
            body: bodyText,
            icon: icon
        });

        notification.onclick = () => {
            window.focus();
            if (sender) selectChat(sender);
        };
    }

    function renderMsg(m) {
        const msgsDiv = document.getElementById('msgs');
        const d = document.createElement('div');
        d.className = `msg ${m.sid === me.username ? 'my' : ''}`;
        
        let content = `<b>${m.user}</b><br>`;
        
        if (m.voice) {
            content += `<audio controls src="${m.voice}" style="width: 200px; height: 35px;"></audio>`;
        } else if (m.file) {
            if (m.fileType.startsWith('image/')) {
                content += `<img src="${m.file}" onclick="window.open(this.src)">`;
            } else if (m.fileType.startsWith('video/')) {
                content += `<video controls src="${m.file}"></video>`;
            } else {
                content += `<a href="${m.file}" download="${m.fileName}">üìÑ ${m.fileName}</a>`;
            }
        } else {
            content += m.text;
        }
        
        content += `<span class="msg-time">${m.time || ''}</span>`;
        d.innerHTML = content;
        msgsDiv.appendChild(d);
        msgsDiv.scrollTop = msgsDiv.scrollHeight;
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    initNotifications().catch(console.error);
    </script>
</body>
</html>
