<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Clone - Final</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --blue: #2481cc; --bg: #e7ebf0; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f5; height: 100vh; display: flex; overflow: hidden; }
        
        #auth-ui, #prof-ui { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { width: 320px; text-align: center; border: 1px solid #ddd; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--blue); color: white; border: none; cursor: pointer; font-weight: bold; }

        #main-ui { display: none; width: 100%; height: 100vh; grid-template-columns: 300px 1fr 250px; }
        
        .sidebar { background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .user-list-container { flex: 1; overflow-y: auto; }
        .user-item { padding: 12px; border-bottom: 1px solid #f9f9f9; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-item:hover { background: #f0f7ff; }
        .user-item.active-chat { border-left: 4px solid var(--blue); background: #f8fbff; }
        .ava { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #eee; }

        .chat-area { display: flex; flex-direction: column; background: var(--bg); border-right: 1px solid #ddd; height: 100vh; overflow: hidden; }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; max-width: 75%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.my { align-self: flex-end; background: #effdde; }
        .msg-time { font-size: 10px; color: #888; display: block; text-align: right; margin-top: 5px; }

        .input-panel { padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #ddd; }

        .emoji-panel { background: white; padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 100vh; }
        .emoji-btn { font-size: 26px; cursor: pointer; padding: 8px; border-radius: 8px; text-align: center; }
        .emoji-btn:hover { background: #f0f0f0; }
    </style>
</head>
<body>

    <div id="auth-ui">
        <div class="card">
            <h2 id="atitle">–í—Ö–æ–¥</h2>
            <input type="text" id="au" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="ap" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" id="ap2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display:none">
            <button onclick="doAuth()">–î–∞–ª–µ–µ</button>
            <p onclick="swapMode()" style="color:var(--blue); cursor:pointer; font-size:13px">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>
    </div>

    <div id="prof-ui" style="display:none">
        <div class="card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <input type="text" id="p_nick" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="text" id="p_sys" placeholder="@username">
            <input type="file" id="p_ava" accept="image/*">
            <button onclick="doProf()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>–ú–æ–∏ —á–∞—Ç—ã</span>
                <button onclick="logout()" style="width:auto; margin:0; padding:4px 8px; background:#ff4d4d; font-size:11px">–í—ã–π—Ç–∏</button>
            </div>
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." style="margin:10px; width:calc(100% - 20px)">
            <div id="user-list" class="user-list-container"></div>
        </div>

        <div class="chat-area">
            <div id="msgs"></div>
            <div class="input-panel">
                <input type="text" id="mi" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter') send()">
                <button onclick="send()" style="width:60px; margin:0">üì§</button>
            </div>
        </div>

        <div class="emoji-panel" id="emoji-list"></div>
    </div>

    <script>
        const socket = io();
        let me = null, isReg = false, base64Ava = "", tempPass = "";
        let allUsers = [], currentRoom = null;

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º sessionStorage –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –≤–∫–ª–∞–¥–æ–∫
        let activeChatters = new Set(JSON.parse(sessionStorage.getItem('tg_active_chats') || "[]"));

        const emojis = "üòÄ üòÅ üòÇ ü§£ üòÉ üòÑ üòÖ üòÜ üòâ üòä üòã üòé üòç üòò ü•∞ üòó üòô ü•≤ üòö ‚ò∫Ô∏è üôÇ ü§ó ü§© ü§î ü´° ü§® üòê üòë üò∂ ü´• üôÑ üòè üò£ üò• üòÆ ü§ê üòØ üò™ üò´ ü•± üò¥ üòå üòõ üòú üòù ü§§ üòí üòì üòî üòï ü´§ üôÉ ü´† ü§ë üò≤ ‚òπÔ∏è üôÅ üòñ üòû üòü üò§ üò¢ üò≠ üò¶ üòß üò® üò© ü§Ø üò¨ üò∞ üò± ü•µ ü•∂ üò≥ ü§™ üòµ üòµ‚Äçüí´ ü•¥ üò† üò° ü§¨ üòá ü•≥ ü•∏ ü•∫ ü•π ü§† ü§° ü§• ü§´ ü§≠ ü´¢ ü´£ üßê ü§ì üòà üëø üëπ üë∫ üíÄ ‚ò†Ô∏è üëª üëΩ üëæ ü§ñ üí©".split(/\s+/);

        function saveToDisk() {
            sessionStorage.setItem('tg_active_chats', JSON.stringify(Array.from(activeChatters)));
        }

        const ep = document.getElementById('emoji-list');
        emojis.forEach(e => {
            const div = document.createElement('div');
            div.className = 'emoji-btn';
            div.innerText = e;
            div.onclick = () => { 
                const mi = document.getElementById('mi');
                mi.value += e + " "; 
                mi.focus(); 
            };
            ep.appendChild(div);
        });

        window.onload = () => {
            const saved = sessionStorage.getItem('tg_user');
            if(saved) {
                me = JSON.parse(saved);
                startApp();
                socket.emit('auth_request', { username: me.username, password: me.password, isRegister: false });
            }
        };

        function swapMode() {
            isReg = !isReg;
            document.getElementById('atitle').innerText = isReg ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥';
            document.getElementById('ap2').style.display = isReg ? 'block' : 'none';
        }

        function doAuth() {
            const u = document.getElementById('au').value, p = document.getElementById('ap').value;
            if(!u || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è!");
            tempPass = p;
            socket.emit('auth_request', { username: u, password: p, isRegister: isReg });
        }

        socket.on('auth_success', (res) => {
            if(res.needProfile) {
                me = { username: res.username, password: tempPass };
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('prof-ui').style.display = 'flex';
            } else {
                me = res.user;
                sessionStorage.setItem('tg_user', JSON.stringify(me));
                startApp();
            }
        });

        document.getElementById('p_ava').onchange = (e) => {
            const r = new FileReader();
            r.onload = () => base64Ava = r.result;
            r.readAsDataURL(e.target.files[0]);
        };

        function doProf() {
            me.nickname = document.getElementById('p_nick').value;
            me.sysName = document.getElementById('p_sys').value;
            me.avatar = base64Ava;
            socket.emit('save_profile', me);
        }

        socket.on('profile_ready', (u) => { me = u; sessionStorage.setItem('tg_user', JSON.stringify(me)); startApp(); });

        function startApp() {
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('prof-ui').style.display = 'none';
            document.getElementById('main-ui').style.display = 'grid';
            updateSidebar(); 
        }

        function updateSidebar() {
            const query = document.getElementById('user-search').value.toLowerCase().trim();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            if(!me) return;

            allUsers.forEach(u => {
                if(u.username === me.username) return;
                const isSearching = query !== "" && (u.nickname.toLowerCase().includes(query) || u.sysName.toLowerCase().includes(query));
                const isChatActive = activeChatters.has(u.username);

                if(isSearching || isChatActive) {
                    const div = document.createElement('div');
                    div.className = `user-item ${isChatActive ? 'active-chat' : ''}`;
                    div.onclick = () => selectChat(u);
                    div.innerHTML = `<img src="${u.avatar || ''}" class="ava"> <div><b>${u.nickname}</b><br><small>${isChatActive ? 'üí¨ –ê–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç' : '@'+u.sysName}</small></div>`;
                    list.appendChild(div);
                }
            });
        }

        function selectChat(partner) {
            const ids = [me.username, partner.username].sort();
            currentRoom = ids[0] + "_" + ids[1];
            activeChatters.add(partner.username);
            saveToDisk();
            document.getElementById('msgs').innerHTML = ''; 
            socket.emit('join_chat', currentRoom);
            updateSidebar();
        }

        document.getElementById('user-search').oninput = updateSidebar;

        socket.on('init_data', (d) => {
            if (!d) return;
            allUsers = d.users || [];
            if (d.messages && Array.isArray(d.messages) && me) {
                d.messages.forEach(m => {
                    const parts = m.room.split('_');
                    if (parts.includes(me.username)) {
                        const other = parts.find(id => id !== me.username);
                        if (other) activeChatters.add(other);
                    }
                });
                saveToDisk();
            }
            updateSidebar();
        });

        socket.on('update_users', (u) => { allUsers = u; updateSidebar(); });

        function send() {
            const i = document.getElementById('mi');
            if(!i.value || !currentRoom) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            socket.emit('message', { room: currentRoom, text: i.value, user: me.nickname, sid: me.username, time });
            i.value = '';
        }

        socket.on('message', (m) => {
            if(!me) return;
            const parts = m.room.split('_');
            if(parts.includes(me.username)) {
                const other = parts.find(id => id !== me.username);
                if(other) {
                    activeChatters.add(other);
                    saveToDisk();
                    updateSidebar();
                }
            }
            if(m.room === currentRoom) renderMsg(m);
        });

        socket.on('chat_history', (h) => { h.forEach(renderMsg); });

        function renderMsg(m) {
            const msgsDiv = document.getElementById('msgs');
            const d = document.createElement('div');
            d.className = `msg ${m.sid === me.username ? 'my' : ''}`;
            d.innerHTML = `<b>${m.user}</b><br>${m.text}<span class="msg-time">${m.time || ''}</span>`;
            msgsDiv.appendChild(d);
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
        }

        function logout() { sessionStorage.clear(); location.reload(); }
        socket.on('auth_error', (e) => alert(e));
    </script>
</body>
</html>
