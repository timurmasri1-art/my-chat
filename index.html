<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Telegram Clone - Pro Edition</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --blue: #2481cc; --bg: #e7ebf0; --yellow: #f4b400; }
        body { font-family: sans-serif; margin: 0; background: #f4f4f5; height: 100vh; display: flex; overflow: hidden; }
        
        #auth-ui, #prof-ui { position: fixed; inset: 0; background: white; z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .card { width: 320px; text-align: center; border: 1px solid #ddd; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        button { background: var(--blue); color: white; border: none; cursor: pointer; font-weight: bold; }

        #main-ui { display: none; width: 100%; height: 100vh; grid-template-columns: 300px 1fr 250px; }
        
        .sidebar { background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; height: 100vh; }
        .sidebar-header { padding: 15px; font-weight: bold; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .user-list-container { flex: 1; overflow-y: auto; }
        .user-item { padding: 12px; border-bottom: 1px solid #f9f9f9; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .user-item:hover { background: #f0f7ff; }
        .user-item.active-chat { border-left: 4px solid var(--blue); background: #f8fbff; }
        .ava { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: #eee; }

        .chat-area { display: flex; flex-direction: column; background: var(--bg); border-right: 1px solid #ddd; height: 100vh; overflow: hidden; }
        #msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .msg { background: white; padding: 10px 15px; border-radius: 12px; margin-bottom: 8px; max-width: 75%; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg.my { align-self: flex-end; background: #effdde; }
        .msg-time { font-size: 10px; color: #888; display: block; text-align: right; margin-top: 5px; }
        
        /* –ú–µ–¥–∏–∞ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö */
        .msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }
        .msg video { max-width: 100%; border-radius: 8px; }

        .input-panel { padding: 15px; background: white; display: flex; gap: 10px; border-top: 1px solid #ddd; align-items: center; }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–∫—Ä–µ–ø–∫–∏ */
        .attach-btn { width: 50px !important; background: var(--yellow) !important; font-size: 20px; margin: 0 !important; }
        
        .voice-btn { width: 50px !important; background: #50a33a !important; font-size: 20px; user-select: none; transition: 0.2s; margin: 0 !important; }
        .voice-btn.recording { background: #ff4d4d !important; animation: pulse 1s infinite; }
        
        #mi { flex: 1; } /* –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */
        #v-timer { color: #ff4d4d; font-weight: bold; font-size: 14px; display: none; min-width: 30px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .emoji-panel { background: white; padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; height: 100vh; }
        .emoji-btn { font-size: 26px; cursor: pointer; padding: 8px; border-radius: 8px; text-align: center; }
    </style>
</head>
<body>

    <div id="auth-ui">
        <div class="card">
            <h2 id="atitle">–í—Ö–æ–¥</h2>
            <input type="text" id="au" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="ap" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="password" id="ap2" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" style="display:none">
            <button onclick="doAuth()">–î–∞–ª–µ–µ</button>
            <p onclick="swapMode()" style="color:var(--blue); cursor:pointer; font-size:13px">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p>
        </div>
    </div>

    <div id="prof-ui" style="display:none">
        <div class="card">
            <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <input type="text" id="p_nick" placeholder="–í–∞—à–µ –ò–º—è">
            <input type="text" id="p_sys" placeholder="@username">
            <input type="file" id="p_ava" accept="image/*">
            <button onclick="doProf()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <div id="main-ui">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>–ú–æ–∏ —á–∞—Ç—ã</span>
                <button onclick="logout()" style="width:auto; margin:0; padding:4px 8px; background:#ff4d4d; font-size:11px">–í—ã–π—Ç–∏</button>
            </div>
            <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." style="margin:10px; width:calc(100% - 20px)">
            <div id="user-list" class="user-list-container"></div>
        </div>

        <div class="chat-area">
            <div id="msgs"></div>
            <div class="input-panel">
                <input type="file" id="file-input" style="display:none" onchange="handleFileSelect(this)">
                <button class="attach-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                
                <input type="text" id="mi" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeydown="if(event.key==='Enter') send()">
                
                <span id="v-timer">20s</span>
                <button id="v-btn" class="voice-btn">üéô</button>
                <button onclick="send()" style="width:60px; margin:0">üì§</button>
            </div>
        </div>

        <div class="emoji-panel" id="emoji-list"></div>
    </div>

    <script>
        const socket = io();
        let me = null, allUsers = [], currentRoom = null, isReg = false;
        let activeChatters = new Set(JSON.parse(sessionStorage.getItem('tg_active_chats') || "[]"));

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
        async function checkPerms() {
            if (!("Notification" in window)) return;
            let perms = await Notification.requestPermission();
            if (perms !== "granted") {
                document.body.innerHTML = "<div style='padding:50px; text-align:center'><h1>–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h1><p>–î–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Ö –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p></div>";
            }
        }
        checkPerms();

        function showPush(m) {
            if (m.sid === me.username) return; // –ù–µ —Å–ø–∞–º–∏–º —Å–µ–±–µ
            const sender = allUsers.find(u => u.username === m.sid);
            new Notification(m.user, {
                body: m.text || (m.voice ? "üé§ –ì–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" : "üìÅ –§–∞–π–ª"),
                icon: sender ? sender.avatar : ""
            });
        }

        // --- –§–ê–ô–õ–´ –ò CTRL+V ---
        document.getElementById('mi').onpaste = (e) => {
            const item = e.clipboardData.items[0];
            if (item && item.type.includes('image')) sendFile(item.getAsFile());
        };

        function handleFileSelect(input) {
            if (input.files[0]) sendFile(input.files[0]);
            input.value = '';
        }

        function sendFile(file) {
            if (!currentRoom) return alert("–í—ã–±–µ—Ä–∏ —á–∞—Ç!");
            const r = new FileReader();
            r.onload = (e) => {
                const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                socket.emit('message', { 
                    room: currentRoom, 
                    file: e.target.result, 
                    fileType: file.type, 
                    fileName: file.name,
                    user: me.nickname, sid: me.username, time 
                });
            };
            r.readAsDataURL(file);
        }

        // --- –õ–û–ì–ò–ö–ê –ì–° ---
        let mediaRecorder, audioChunks = [], stream = null, recordingTimeout, timerInterval;
        const vBtn = document.getElementById('v-btn'), vTimer = document.getElementById('v-timer');

        async function initMedia() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.ondataavailable = (e) => audioChunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                    if (blob.size < 1000) return;
                    const reader = new FileReader();
                    reader.readAsDataURL(blob);
                    reader.onloadend = () => {
                        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        socket.emit('message', { room: currentRoom, voice: reader.result, user: me.nickname, sid: me.username, time });
                    };
                    audioChunks = [];
                };
                return true;
            } catch { alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"); return false; }
        }

        vBtn.onmousedown = async () => {
            if (!currentRoom) return;
            if (!stream && !(await initMedia())) return;
            vBtn.classList.add('recording');
            audioChunks = [];
            mediaRecorder.start();
            let timeLeft = 20;
            vTimer.innerText = timeLeft + "s"; vTimer.style.display = "inline";
            timerInterval = setInterval(() => {
                timeLeft--; vTimer.innerText = timeLeft + "s";
                if (timeLeft <= 0) vBtn.onmouseup();
            }, 1000);
        };

        vBtn.onmouseup = () => {
            if (mediaRecorder?.state === "recording") {
                vBtn.classList.remove('recording');
                clearInterval(timerInterval);
                vTimer.style.display = "none";
                mediaRecorder.stop();
            }
        };

        // --- –°–ò–°–¢–ï–ú–ù–ê–Ø –õ–û–ì–ò–ö–ê ---
        function swapMode() {
            isReg = !isReg;
            document.getElementById('atitle').innerText = isReg ? '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è' : '–í—Ö–æ–¥';
            document.getElementById('ap2').style.display = isReg ? 'block' : 'none';
        }

        function doAuth() {
            const u = document.getElementById('au').value, p = document.getElementById('ap').value;
            socket.emit('auth_request', { username: u, password: p, isRegister: isReg });
        }

        socket.on('auth_success', (res) => {
            if(res.needProfile) {
                me = { username: res.username };
                document.getElementById('auth-ui').style.display = 'none';
                document.getElementById('prof-ui').style.display = 'flex';
            } else {
                me = res.user;
                sessionStorage.setItem('tg_user', JSON.stringify(me));
                startApp();
            }
        });

        function doProf() {
            me.nickname = document.getElementById('p_nick').value;
            me.sysName = document.getElementById('p_sys').value;
            const file = document.getElementById('p_ava').files[0];
            if (file) {
                const r = new FileReader();
                r.onload = () => { me.avatar = r.result; socket.emit('save_profile', me); };
                r.readAsDataURL(file);
            } else { socket.emit('save_profile', me); }
        }

        socket.on('profile_ready', (u) => { me = u; sessionStorage.setItem('tg_user', JSON.stringify(me)); startApp(); });

        function startApp() {
            document.getElementById('auth-ui').style.display = 'none';
            document.getElementById('prof-ui').style.display = 'none';
            document.getElementById('main-ui').style.display = 'grid';
            updateSidebar();
        }

        function updateSidebar() {
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            allUsers.forEach(u => {
                if(me && u.username === me.username) return;
                if(activeChatters.has(u.username) || document.getElementById('user-search').value) {
                    const div = document.createElement('div');
                    div.className = `user-item ${currentRoom?.includes(u.username) ? 'active-chat' : ''}`;
                    div.onclick = () => selectChat(u);
                    div.innerHTML = `<img src="${u.avatar || ''}" class="ava"> <div><b>${u.nickname}</b><br><small>@${u.sysName}</small></div>`;
                    list.appendChild(div);
                }
            });
        }

        function selectChat(partner) {
            const ids = [me.username, partner.username].sort();
            currentRoom = ids[0] + "_" + ids[1];
            activeChatters.add(partner.username);
            sessionStorage.setItem('tg_active_chats', JSON.stringify(Array.from(activeChatters)));
            document.getElementById('msgs').innerHTML = '';
            socket.emit('join_chat', currentRoom);
            updateSidebar();
        }

        function send() {
            const i = document.getElementById('mi');
            if(!i.value || !currentRoom) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            socket.emit('message', { room: currentRoom, text: i.value, user: me.nickname, sid: me.username, time });
            i.value = '';
        }

        function renderMsg(m) {
            const msgsDiv = document.getElementById('msgs');
            const d = document.createElement('div');
            d.className = `msg ${m.sid === me.username ? 'my' : ''}`;
            let content = `<b>${m.user}</b><br>`;
            
            if (m.voice) content += `<audio controls src="${m.voice}"></audio>`;
            else if (m.file) {
                if (m.fileType.includes('image')) content += `<img src="${m.file}" onclick="window.open(this.src)">`;
                else if (m.fileType.includes('video')) content += `<video controls src="${m.file}"></video>`;
                else content += `<a href="${m.file}" download="${m.fileName}">üìÑ ${m.fileName}</a>`;
            } else content += m.text;

            content += `<span class="msg-time">${m.time || ''}</span>`;
            d.innerHTML = content;
            msgsDiv.appendChild(d);
            msgsDiv.scrollTop = msgsDiv.scrollHeight;
        }

        socket.on('init_data', (d) => { allUsers = d.users || []; updateSidebar(); });
        socket.on('update_users', (u) => { allUsers = u; updateSidebar(); });
        socket.on('message', (m) => { 
            if(m.room === currentRoom) renderMsg(m); 
            else showPush(m); 
        });
        socket.on('chat_history', (h) => h.forEach(renderMsg));
        function logout() { sessionStorage.clear(); location.reload(); }
        
        // Emoji
        const emojis = "üòÄ üòÇ üòä üòç üòé ü§î ü§® üòê üò∂ üôÑ üòè üò• üòÆ ü§ê üò¥ üòõ üòí üòî üòï üò≤ ‚òπÔ∏è üòñ üò¢ üò≠ üò© ü§Ø üò∞ üò± ü•µ ü•∂ üò≥ üòµ üò† üò° ü§¨ üòá ü•≥ ü§° üí©".split(" ");
        const ep = document.getElementById('emoji-list');
        emojis.forEach(e => {
            const div = document.createElement('div'); div.className = 'emoji-btn'; div.innerText = e;
            div.onclick = () => { document.getElementById('mi').value += e; document.getElementById('mi').focus(); };
            ep.appendChild(div);
        });
    </script>
</body>
</html>
